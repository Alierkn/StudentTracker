{% extends "base.html" %}

{% block title %}{{ student.full_name }} - Detay - EducationalTR{% endblock %}

{% block content %}
<div class="student-detail-page">
    <div class="detail-header">
        <a href="{{ url_for('admin_dashboard') }}" class="back-link">‚Üê Geri</a>
        <h1>{{ student.full_name }}</h1>
        <p class="subtitle">@{{ student.username }} - {{ student.email or 'E-posta yok' }}</p>
        <div class="detail-actions">
            <a href="{{ url_for('admin_view_schedule', student_id=student.id) }}" class="btn btn-primary">üìÖ Ders Programƒ±nƒ± G√∂r√ºnt√ºle</a>
            <button onclick="deleteStudent({{ student.id }}, '{{ student.username }}')" class="btn btn-danger" title="√ñƒürenciyi Sil">
                üóëÔ∏è √ñƒürenciyi Sil
            </button>
        </div>
    </div>

    <div class="detail-sections">
        <!-- √áalƒ±≈üma Kayƒ±tlarƒ± -->
        <div class="detail-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>üìñ √áalƒ±≈üma Kayƒ±tlarƒ±</h2>
                <button onclick="addStudySession({{ student.id }})" class="btn btn-primary btn-sm">+ √áalƒ±≈üma Kaydƒ± Ekle</button>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Ders</th>
                            <th>Saat</th>
                            <th>Verimlilik</th>
                            <th>Notlar</th>
                            <th>Zorluklar</th>
                            <th>ƒ∞≈ülem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if sessions %}
                            {% for session in sessions %}
                            <tr>
                                <td>{{ session.date }}</td>
                                <td>{{ session.subject }}</td>
                                <td>{{ "%.1f"|format(session.hours) }} saat</td>
                                <td>
                                    <span class="efficiency-badge efficiency-{{ 'high' if session.efficiency >= 70 else 'medium' if session.efficiency >= 50 else 'low' }}">
                                        {{ session.efficiency }}%
                                    </span>
                                </td>
                                <td>{{ session.notes[:50] if session.notes else '-' }}{{ '...' if session.notes and session.notes|length > 50 else '' }}</td>
                                <td>{{ session.difficulties[:50] if session.difficulties else '-' }}{{ '...' if session.difficulties and session.difficulties|length > 50 else '' }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button onclick="editStudySession({{ session.id }})" class="btn-edit" title="D√ºzenle">
                                            ‚úèÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" class="empty-state">Hen√ºz √ßalƒ±≈üma kaydƒ± yok</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sƒ±nav Sonu√ßlarƒ± -->
        <div class="detail-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>üìù Sƒ±nav Sonu√ßlarƒ±</h2>
                <button onclick="addExam({{ student.id }})" class="btn btn-primary btn-sm">+ Sƒ±nav Sonucu Ekle</button>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Sƒ±nav Adƒ±</th>
                            <th>Not</th>
                            <th>Maksimum</th>
                            <th>Y√ºzde</th>
                            <th>Tarih</th>
                            <th>ƒ∞≈ülem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if exams %}
                            {% for exam in exams %}
                            <tr>
                                <td>{{ exam.exam_name }}</td>
                                <td>{{ "%.1f"|format(exam.score) }}</td>
                                <td>{{ "%.1f"|format(exam.max_score) }}</td>
                                <td>
                                    <span class="grade-badge grade-{{ 'excellent' if (exam.score * 100 / exam.max_score) >= 90 else 'good' if (exam.score * 100 / exam.max_score) >= 70 else 'average' if (exam.score * 100 / exam.max_score) >= 50 else 'poor' }}">
                                        {{ "%.1f"|format(exam.score * 100 / exam.max_score) }}%
                                    </span>
                                </td>
                                <td>{{ exam.exam_date or '-' }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button onclick="editExam({{ exam.id }})" class="btn-edit" title="D√ºzenle">
                                            ‚úèÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="empty-state">Hen√ºz sƒ±nav sonucu yok</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- √áalƒ±≈üma Kaydƒ± D√ºzenleme Modal -->
<div id="editStudyModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚úèÔ∏è √áalƒ±≈üma Kaydƒ±nƒ± D√ºzenle</h2>
            <span class="close" onclick="closeEditStudyModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form onsubmit="event.preventDefault(); updateStudySession();">
                <input type="hidden" id="editStudySessionId">
                
                <div class="form-group">
                    <label for="editStudyDate">Tarih *</label>
                    <input type="date" id="editStudyDate" required>
                </div>

                <div class="form-group">
                    <label for="editStudySubject">Ders/Konu *</label>
                    <input type="text" id="editStudySubject" required placeholder="√ñrn: Matematik, Fizik, Kimya...">
                </div>

                <div class="form-group">
                    <label for="editStudyHours">√áalƒ±≈üma S√ºresi (Saat) *</label>
                    <input type="number" id="editStudyHours" min="0.1" max="24" step="0.1" required placeholder="√ñrn: 2.5">
                </div>

                <div class="form-group">
                    <label for="editStudyEfficiency">Verimlilik (%) *</label>
                    <input type="range" id="editStudyEfficiency" min="0" max="100" value="50" oninput="updateEditStudyEfficiencyValue(this.value)" required>
                    <div class="range-display">
                        <span id="editStudyEfficiencyValue">50</span>%
                    </div>
                </div>

                <div class="form-group">
                    <label for="editStudyNotes">Notlar (Opsiyonel)</label>
                    <textarea id="editStudyNotes" rows="4" placeholder="√áalƒ±≈ütƒ±ƒüƒ±nƒ±z konular, √∂nemli noktalar..."></textarea>
                </div>

                <div class="form-group">
                    <label for="editStudyDifficulties">Anlamadƒ±ƒüƒ±nƒ±z Yerler (Opsiyonel)</label>
                    <textarea id="editStudyDifficulties" rows="3" placeholder="Anlamadƒ±ƒüƒ±nƒ±z veya zorlandƒ±ƒüƒ±nƒ±z konular..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">G√ºncelle</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditStudyModal()">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- √áalƒ±≈üma Kaydƒ± Ekleme Modal -->
<div id="addStudyModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚ûï √áalƒ±≈üma Kaydƒ± Ekle</h2>
            <span class="close" onclick="closeAddStudyModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form onsubmit="event.preventDefault(); submitAddStudy();">
                <input type="hidden" id="addStudyStudentId">
                
                <div class="form-group">
                    <label for="addStudyDate">Tarih *</label>
                    <input type="date" id="addStudyDate" required>
                </div>

                <div class="form-group">
                    <label for="addStudySubject">Ders/Konu *</label>
                    <input type="text" id="addStudySubject" required placeholder="√ñrn: Matematik, Fizik, Kimya...">
                </div>

                <div class="form-group">
                    <label for="addStudyHours">√áalƒ±≈üma S√ºresi (Saat) *</label>
                    <input type="number" id="addStudyHours" min="0.1" max="24" step="0.1" required placeholder="√ñrn: 2.5">
                </div>

                <div class="form-group">
                    <label for="addStudyEfficiency">Verimlilik (%) *</label>
                    <input type="range" id="addStudyEfficiency" min="0" max="100" value="50" oninput="updateAddStudyEfficiencyValue(this.value)" required>
                    <div class="range-display">
                        <span id="addStudyEfficiencyValue">50</span>%
                    </div>
                </div>

                <div class="form-group">
                    <label for="addStudyNotes">Notlar (Opsiyonel)</label>
                    <textarea id="addStudyNotes" rows="4" placeholder="√áalƒ±≈ütƒ±ƒüƒ±nƒ±z konular, √∂nemli noktalar..."></textarea>
                </div>

                <div class="form-group">
                    <label for="addStudyDifficulties">Anlamadƒ±ƒüƒ±nƒ±z Yerler (Opsiyonel)</label>
                    <textarea id="addStudyDifficulties" rows="3" placeholder="Anlamadƒ±ƒüƒ±nƒ±z veya zorlandƒ±ƒüƒ±nƒ±z konular..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Ekle</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddStudyModal()">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sƒ±nav Sonucu D√ºzenleme Modal -->
<div id="editExamModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚úèÔ∏è Sƒ±nav Sonucunu D√ºzenle</h2>
            <span class="close" onclick="closeEditExamModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form onsubmit="event.preventDefault(); updateExam();">
                <input type="hidden" id="editExamId">
                
                <div class="form-group">
                    <label for="editExamName">Sƒ±nav Adƒ± *</label>
                    <input type="text" id="editExamName" required placeholder="√ñrn: Matematik Vize 1, Fizik Final...">
                </div>

                <div class="form-group">
                    <label for="editExamScore">Aldƒ±ƒüƒ± Not *</label>
                    <input type="number" id="editExamScore" min="0" step="0.1" required placeholder="√ñrn: 85">
                </div>

                <div class="form-group">
                    <label for="editExamMaxScore">Maksimum Not</label>
                    <input type="number" id="editExamMaxScore" min="1" value="100" step="0.1" placeholder="100">
                </div>

                <div class="form-group">
                    <label for="editExamDate">Sƒ±nav Tarihi</label>
                    <input type="date" id="editExamDate">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">G√ºncelle</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditExamModal()">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sƒ±nav Sonucu Ekleme Modal -->
<div id="addExamModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚ûï Sƒ±nav Sonucu Ekle</h2>
            <span class="close" onclick="closeAddExamModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form onsubmit="event.preventDefault(); submitAddExam();">
                <input type="hidden" id="addExamStudentId">
                
                <div class="form-group">
                    <label for="addExamName">Sƒ±nav Adƒ± *</label>
                    <input type="text" id="addExamName" required placeholder="√ñrn: Matematik Vize 1, Fizik Final...">
                </div>

                <div class="form-group">
                    <label for="addExamScore">Aldƒ±ƒüƒ± Not *</label>
                    <input type="number" id="addExamScore" min="0" step="0.1" required placeholder="√ñrn: 85">
                </div>

                <div class="form-group">
                    <label for="addExamMaxScore">Maksimum Not</label>
                    <input type="number" id="addExamMaxScore" min="1" value="100" step="0.1" placeholder="100">
                </div>

                <div class="form-group">
                    <label for="addExamDate">Sƒ±nav Tarihi</label>
                    <input type="date" id="addExamDate">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Ekle</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddExamModal()">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const studentId = {{ student.id }};

    function deleteStudent(studentId, username) {
        if (!confirm(`"${username}" kullanƒ±cƒ±sƒ±nƒ± silmek istediƒüinize emin misiniz?\n\nBu i≈ülem geri alƒ±namaz! √ñƒürencinin t√ºm √ßalƒ±≈üma kayƒ±tlarƒ±, sƒ±nav sonu√ßlarƒ± ve ders programlarƒ± da silinecektir.`)) {
            return;
        }
        
        fetch(`/admin/student/${studentId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('√ñƒürenci ba≈üarƒ±yla silindi!');
                window.location.href = '{{ url_for("admin_dashboard") }}';
            } else {
                alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(error => {
            console.error('Silme hatasƒ±:', error);
            alert('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
        });
    }

    // √áalƒ±≈üma kaydƒ± d√ºzenle
    function editStudySession(id) {
        fetch(`/admin/study/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const study = data.data;
                    document.getElementById('editStudySessionId').value = study.id;
                    document.getElementById('editStudyDate').value = study.date;
                    document.getElementById('editStudySubject').value = study.subject;
                    document.getElementById('editStudyHours').value = study.hours;
                    document.getElementById('editStudyEfficiency').value = study.efficiency;
                    document.getElementById('editStudyEfficiencyValue').textContent = study.efficiency;
                    document.getElementById('editStudyNotes').value = study.notes || '';
                    document.getElementById('editStudyDifficulties').value = study.difficulties || '';
                    document.getElementById('editStudyModal').style.display = 'flex';
                } else {
                    alert('Kayƒ±t bilgileri alƒ±namadƒ±: ' + (data.error || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                alert('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
            });
    }

    // √áalƒ±≈üma kaydƒ± ekle
    function addStudySession(studentId) {
        document.getElementById('addStudyStudentId').value = studentId;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('addStudyDate').value = today;
        document.getElementById('addStudySubject').value = '';
        document.getElementById('addStudyHours').value = '';
        document.getElementById('addStudyEfficiency').value = 50;
        document.getElementById('addStudyEfficiencyValue').textContent = 50;
        document.getElementById('addStudyNotes').value = '';
        document.getElementById('addStudyDifficulties').value = '';
        document.getElementById('addStudyModal').style.display = 'flex';
    }

    // √áalƒ±≈üma kaydƒ± g√ºncelle
    function updateStudySession() {
        const id = document.getElementById('editStudySessionId').value;
        const formData = {
            date: document.getElementById('editStudyDate').value,
            subject: document.getElementById('editStudySubject').value,
            hours: parseFloat(document.getElementById('editStudyHours').value),
            efficiency: parseInt(document.getElementById('editStudyEfficiency').value),
            notes: document.getElementById('editStudyNotes').value,
            difficulties: document.getElementById('editStudyDifficulties').value
        };

        fetch(`/admin/study/${id}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('√áalƒ±≈üma kaydƒ± ba≈üarƒ±yla g√ºncellendi!');
                document.getElementById('editStudyModal').style.display = 'none';
                location.reload();
            } else {
                alert('G√ºncelleme ba≈üarƒ±sƒ±z: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(error => {
            console.error('G√ºncelleme hatasƒ±:', error);
            alert('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
        });
    }

    // √áalƒ±≈üma kaydƒ± ekle (submit)
    function submitAddStudy() {
        const studentId = document.getElementById('addStudyStudentId').value;
        const formData = {
            date: document.getElementById('addStudyDate').value,
            subject: document.getElementById('addStudySubject').value,
            hours: parseFloat(document.getElementById('addStudyHours').value),
            efficiency: parseInt(document.getElementById('addStudyEfficiency').value),
            notes: document.getElementById('addStudyNotes').value,
            difficulties: document.getElementById('addStudyDifficulties').value
        };

        fetch(`/admin/student/${studentId}/study/add`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('√áalƒ±≈üma kaydƒ± ba≈üarƒ±yla eklendi!');
                document.getElementById('addStudyModal').style.display = 'none';
                location.reload();
            } else {
                alert('Ekleme ba≈üarƒ±sƒ±z: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(error => {
            console.error('Ekleme hatasƒ±:', error);
            alert('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
        });
    }

    // Sƒ±nav sonucu d√ºzenle
    function editExam(id) {
        fetch(`/admin/exam/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const exam = data.data;
                    document.getElementById('editExamId').value = exam.id;
                    document.getElementById('editExamName').value = exam.exam_name;
                    document.getElementById('editExamScore').value = exam.score;
                    document.getElementById('editExamMaxScore').value = exam.max_score;
                    document.getElementById('editExamDate').value = exam.exam_date || '';
                    document.getElementById('editExamModal').style.display = 'flex';
                } else {
                    alert('Kayƒ±t bilgileri alƒ±namadƒ±: ' + (data.error || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                alert('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
            });
    }

    // Sƒ±nav sonucu ekle
    function addExam(studentId) {
        document.getElementById('addExamStudentId').value = studentId;
        document.getElementById('addExamName').value = '';
        document.getElementById('addExamScore').value = '';
        document.getElementById('addExamMaxScore').value = 100;
        document.getElementById('addExamDate').value = '';
        document.getElementById('addExamModal').style.display = 'flex';
    }

    // Sƒ±nav sonucu g√ºncelle
    function updateExam() {
        const id = document.getElementById('editExamId').value;
        const formData = {
            exam_name: document.getElementById('editExamName').value,
            score: parseFloat(document.getElementById('editExamScore').value),
            max_score: parseFloat(document.getElementById('editExamMaxScore').value),
            exam_date: document.getElementById('editExamDate').value
        };

        fetch(`/admin/exam/${id}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Sƒ±nav sonucu ba≈üarƒ±yla g√ºncellendi!');
                document.getElementById('editExamModal').style.display = 'none';
                location.reload();
            } else {
                alert('G√ºncelleme ba≈üarƒ±sƒ±z: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(error => {
            console.error('G√ºncelleme hatasƒ±:', error);
            alert('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
        });
    }

    // Sƒ±nav sonucu ekle (submit)
    function submitAddExam() {
        const studentId = document.getElementById('addExamStudentId').value;
        const formData = {
            exam_name: document.getElementById('addExamName').value,
            score: parseFloat(document.getElementById('addExamScore').value),
            max_score: parseFloat(document.getElementById('addExamMaxScore').value),
            exam_date: document.getElementById('addExamDate').value
        };

        fetch(`/admin/student/${studentId}/exam/add`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Sƒ±nav sonucu ba≈üarƒ±yla eklendi!');
                document.getElementById('addExamModal').style.display = 'none';
                location.reload();
            } else {
                alert('Ekleme ba≈üarƒ±sƒ±z: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(error => {
            console.error('Ekleme hatasƒ±:', error);
            alert('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
        });
    }

    // Modal kapatma fonksiyonlarƒ±
    function closeEditStudyModal() {
        document.getElementById('editStudyModal').style.display = 'none';
    }

    function closeAddStudyModal() {
        document.getElementById('addStudyModal').style.display = 'none';
    }

    function closeEditExamModal() {
        document.getElementById('editExamModal').style.display = 'none';
    }

    function closeAddExamModal() {
        document.getElementById('addExamModal').style.display = 'none';
    }

    // Verimlilik deƒüerini g√ºncelle
    function updateEditStudyEfficiencyValue(value) {
        document.getElementById('editStudyEfficiencyValue').textContent = value;
    }

    function updateAddStudyEfficiencyValue(value) {
        document.getElementById('addStudyEfficiencyValue').textContent = value;
    }

    // Modal dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
    window.onclick = function(event) {
        const modals = ['editStudyModal', 'addStudyModal', 'editExamModal', 'addExamModal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}

