{% extends "base.html" %}

{% block title %}Ders ProgramÄ± - EducationalTR{% endblock %}

{% block content %}
<div class="schedule-container">
    <div class="schedule-header">
        <h1>ğŸ“… Ders ProgramÄ±m</h1>
        <p class="subtitle">Ders programÄ±nÄ±zÄ± oluÅŸturun, dÃ¼zenleyin ve takip edin</p>
        <button class="btn btn-primary" onclick="openScheduleModal()">+ Yeni Program OluÅŸtur</button>
    </div>

    {% if active_schedule %}
    <div class="schedule-info-card">
        <h2>{{ active_schedule.name }}</h2>
        {% if active_schedule.description %}
        <p>{{ active_schedule.description }}</p>
        {% endif %}
        <div class="schedule-actions">
            <button class="btn btn-secondary" onclick="openEditModal({{ active_schedule.id }})">âœï¸ DÃ¼zenle</button>
            <button class="btn btn-danger" onclick="deleteSchedule({{ active_schedule.id }})">ğŸ—‘ï¸ Sil</button>
        </div>
    </div>

    <div class="schedule-week">
        {% set days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'] %}
        {% for day_num in range(7) %}
        <div class="schedule-day">
            <div class="day-header">
                <h3>{{ days[day_num] }}</h3>
            </div>
            <div class="day-items">
                {% for item in schedule_items %}
                {% if item.day_of_week == day_num %}
                <div class="schedule-item" data-item-id="{{ item.id }}">
                    <div class="item-time">
                        <span class="time-start">{{ item.start_time }}</span>
                        <span class="time-separator">-</span>
                        <span class="time-end">{{ item.end_time }}</span>
                    </div>
                    <div class="item-content">
                        <h4 class="item-subject">{{ item.subject }}</h4>
                        {% if item.location %}
                        <p class="item-location">ğŸ“ {{ item.location }}</p>
                        {% endif %}
                        {% if item.instructor %}
                        <p class="item-instructor">ğŸ‘¤ {{ item.instructor }}</p>
                        {% endif %}
                    </div>
                    <div class="item-actions">
                        <label class="completion-checkbox">
                            <input type="checkbox" 
                                   data-item-id="{{ item.id }}"
                                   onchange="toggleCompletion({{ item.id }}, this.checked)"
                                   {% if completions.get(item.id) %}
                                   {% set today_completion = completions[item.id]|selectattr('completion_date', 'equalto', today)|list|first %}
                                   {% if today_completion and today_completion.is_completed %}checked{% endif %}
                                   {% endif %}>
                            <span class="checkmark">âœ“</span>
                            <span class="check-label">TamamlandÄ±</span>
                        </label>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-schedule">
        <div class="empty-icon">ğŸ“…</div>
        <h2>HenÃ¼z ders programÄ± oluÅŸturulmamÄ±ÅŸ</h2>
        <p>Ders programÄ±nÄ±zÄ± oluÅŸturmak iÃ§in yukarÄ±daki butona tÄ±klayÄ±n</p>
    </div>
    {% endif %}
</div>

<!-- Program OluÅŸtur/DÃ¼zenle Modal -->
<div id="scheduleModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="modalTitle">Yeni Ders ProgramÄ± OluÅŸtur</h2>
            <span class="close" onclick="closeScheduleModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="scheduleForm">
                <input type="hidden" id="scheduleId" name="schedule_id">
                
                <div class="form-group">
                    <label for="scheduleName">Program AdÄ± *</label>
                    <input type="text" id="scheduleName" name="name" required placeholder="Ã–rn: 2024-2025 GÃ¼z DÃ¶nemi">
                </div>
                
                <div class="form-group">
                    <label for="scheduleDescription">AÃ§Ä±klama</label>
                    <textarea id="scheduleDescription" name="description" rows="3" placeholder="Program hakkÄ±nda notlar..."></textarea>
                </div>
                
                <div class="form-group">
                    <h3>Dersler</h3>
                    <div id="scheduleItems">
                        <!-- Dersler buraya eklenecek -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addScheduleItem()">+ Ders Ekle</button>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeScheduleModal()">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let scheduleItems = [];
let editingScheduleId = null;
const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];

function openScheduleModal() {
    editingScheduleId = null;
    document.getElementById('modalTitle').textContent = 'Yeni Ders ProgramÄ± OluÅŸtur';
    document.getElementById('scheduleId').value = '';
    document.getElementById('scheduleName').value = '';
    document.getElementById('scheduleDescription').value = '';
    scheduleItems = [];
    renderScheduleItems();
    document.getElementById('scheduleModal').style.display = 'block';
}

function openEditModal(scheduleId) {
    editingScheduleId = scheduleId;
    document.getElementById('modalTitle').textContent = 'Ders ProgramÄ±nÄ± DÃ¼zenle';
    document.getElementById('scheduleId').value = scheduleId;
    
    // Mevcut program bilgilerini yÃ¼kle
    fetch(`/schedule/${scheduleId}/data`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('scheduleName').value = data.schedule.name;
                document.getElementById('scheduleDescription').value = data.schedule.description || '';
                scheduleItems = data.items || [];
                renderScheduleItems();
                document.getElementById('scheduleModal').style.display = 'block';
            }
        })
        .catch(err => {
            console.error('Hata:', err);
            alert('Program bilgileri yÃ¼klenirken hata oluÅŸtu');
        });
}

function closeScheduleModal() {
    document.getElementById('scheduleModal').style.display = 'none';
}

function addScheduleItem() {
    scheduleItems.push({
        day_of_week: 0,
        start_time: '09:00',
        end_time: '10:00',
        subject: '',
        location: '',
        instructor: ''
    });
    renderScheduleItems();
}

function removeScheduleItem(index) {
    scheduleItems.splice(index, 1);
    renderScheduleItems();
}

function renderScheduleItems() {
    const container = document.getElementById('scheduleItems');
    container.innerHTML = '';
    
    scheduleItems.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'schedule-item-form';
        itemDiv.innerHTML = `
            <div class="item-form-row">
                <div class="form-group-inline">
                    <label>GÃ¼n</label>
                    <select onchange="scheduleItems[${index}].day_of_week = parseInt(this.value)">
                        ${days.map((day, i) => `<option value="${i}" ${item.day_of_week === i ? 'selected' : ''}>${day}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group-inline">
                    <label>BaÅŸlangÄ±Ã§</label>
                    <input type="time" value="${item.start_time}" onchange="scheduleItems[${index}].start_time = this.value">
                </div>
                <div class="form-group-inline">
                    <label>BitiÅŸ</label>
                    <input type="time" value="${item.end_time}" onchange="scheduleItems[${index}].end_time = this.value">
                </div>
            </div>
            <div class="item-form-row">
                <div class="form-group-inline full-width">
                    <label>Ders AdÄ± *</label>
                    <input type="text" value="${item.subject}" required onchange="scheduleItems[${index}].subject = this.value" placeholder="Ã–rn: Matematik">
                </div>
            </div>
            <div class="item-form-row">
                <div class="form-group-inline">
                    <label>Yer</label>
                    <input type="text" value="${item.location || ''}" onchange="scheduleItems[${index}].location = this.value" placeholder="Ã–rn: A-101">
                </div>
                <div class="form-group-inline">
                    <label>Ã–ÄŸretmen</label>
                    <input type="text" value="${item.instructor || ''}" onchange="scheduleItems[${index}].instructor = this.value" placeholder="Ã–rn: Ahmet YÄ±lmaz">
                </div>
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeScheduleItem(${index})">Sil</button>
        `;
        container.appendChild(itemDiv);
    });
    
    if (scheduleItems.length === 0) {
        container.innerHTML = '<p class="empty-message">HenÃ¼z ders eklenmemiÅŸ. YukarÄ±daki butona tÄ±klayarak ders ekleyin.</p>';
    }
}

document.getElementById('scheduleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('scheduleName').value,
        description: document.getElementById('scheduleDescription').value,
        items: scheduleItems
    };
    
    const scheduleId = document.getElementById('scheduleId').value;
    const url = scheduleId ? `/schedule/${scheduleId}/update` : '/schedule/create';
    const method = 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('Program baÅŸarÄ±yla kaydedildi!');
            location.reload();
        } else {
            alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
        }
    })
    .catch(err => {
        console.error('Hata:', err);
        alert('Program kaydedilirken hata oluÅŸtu');
    });
});

function toggleCompletion(itemId, isCompleted) {
    const today = new Date().toISOString().split('T')[0];
    
    fetch(`/schedule/item/${itemId}/complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            date: today,
            is_completed: isCompleted
        })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
            // Checkbox'Ä± geri al
            const checkbox = document.querySelector(`input[data-item-id="${itemId}"]`);
            if (checkbox) checkbox.checked = !isCompleted;
        }
    })
    .catch(err => {
        console.error('Hata:', err);
        alert('Tamamlama durumu gÃ¼ncellenirken hata oluÅŸtu');
        const checkbox = document.querySelector(`input[data-item-id="${itemId}"]`);
        if (checkbox) checkbox.checked = !isCompleted;
    });
}

function deleteSchedule(scheduleId) {
    if (!confirm('Bu programÄ± silmek istediÄŸinizden emin misiniz?')) {
        return;
    }
    
    fetch(`/schedule/${scheduleId}/delete`, {
        method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('Program baÅŸarÄ±yla silindi!');
            location.reload();
        } else {
            alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
        }
    })
    .catch(err => {
        console.error('Hata:', err);
        alert('Program silinirken hata oluÅŸtu');
    });
}

// Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
window.onclick = function(event) {
    const modal = document.getElementById('scheduleModal');
    if (event.target == modal) {
        closeScheduleModal();
    }
}
</script>

{% endblock %}

