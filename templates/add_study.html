{% extends "base.html" %}

{% block title %}Ã‡alÄ±ÅŸma Ekle - EducationalTR{% endblock %}

{% block content %}
<div class="form-page">
    <div class="form-card">
        <div class="form-header">
            <h1>ğŸ“– Yeni Ã‡alÄ±ÅŸma KaydÄ± Ekle</h1>
            <p>GÃ¼nlÃ¼k Ã§alÄ±ÅŸma verilerinizi kaydedin</p>
        </div>

        <form method="POST" class="study-form" id="studyForm" onsubmit="return showConfirmationPopup(event)">
            <div class="form-group">
                <label for="date">Tarih *</label>
                <input type="date" id="date" name="date" value="{{ request.form.date or '' }}" required>
            </div>

            <div class="form-group">
                <label for="subject">Ders/Konu *</label>
                <input type="text" id="subject" name="subject" placeholder="Ã–rn: Matematik, Fizik, Kimya..." required>
            </div>

            <div class="form-group">
                <label for="hours">Ã‡alÄ±ÅŸma SÃ¼resi (Saat) *</label>
                <input type="number" id="hours" name="hours" min="0.1" max="24" step="0.1" placeholder="Ã–rn: 2.5" required>
                <small>Ã–rn: 2.5 saat iÃ§in 2.5 yazÄ±n</small>
            </div>

            <div class="form-group">
                <label for="efficiency">Verimlilik (%) *</label>
                <input type="range" id="efficiency" name="efficiency" min="0" max="100" value="50" oninput="updateEfficiencyValue(this.value)">
                <div class="range-display">
                    <span id="efficiencyValue">50</span>%
                </div>
                <small>Ã‡alÄ±ÅŸmanÄ±zÄ±n ne kadar verimli olduÄŸunu deÄŸerlendirin</small>
            </div>

            <div class="form-group">
                <label for="notes">Notlar (Opsiyonel)</label>
                <textarea id="notes" name="notes" rows="4" placeholder="Ã‡alÄ±ÅŸtÄ±ÄŸÄ±nÄ±z konular, Ã¶nemli noktalar..."></textarea>
            </div>

            <div class="form-group">
                <label for="difficulties">AnlamadÄ±ÄŸÄ±nÄ±z Yerler (Opsiyonel)</label>
                <textarea id="difficulties" name="difficulties" rows="3" placeholder="AnlamadÄ±ÄŸÄ±nÄ±z veya zorlandÄ±ÄŸÄ±nÄ±z konular..."></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-confetti" id="submitBtn">
                    <span class="btn-text" id="btnText">Kaydet</span>
                    <div class="spinner" id="loadingSpinner"></div>
                    <svg class="checkmark" id="successIcon" viewBox="0 0 52 52">
                        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                    </svg>
                </button>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Ä°ptal</a>
            </div>
        </form>
    </div>
</div>

<!-- Komik Pop-up Modal -->
<div id="confirmationModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-icon">ğŸ¤”</span>
            <h2>Yalan SÃ¶ylemiyorsun DeÄŸil Mi?</h2>
        </div>
        <div class="modal-body">
            <p>GirdiÄŸin veriler doÄŸru mu? GerÃ§ekten bu kadar Ã§alÄ±ÅŸtÄ±n mÄ±? ğŸ˜</p>
            <div class="modal-stats">
                <div class="modal-stat-item">
                    <span class="modal-stat-label">Ders:</span>
                    <span class="modal-stat-value" id="previewSubject">-</span>
                </div>
                <div class="modal-stat-item">
                    <span class="modal-stat-label">SÃ¼re:</span>
                    <span class="modal-stat-value" id="previewHours">-</span>
                </div>
                <div class="modal-stat-item">
                    <span class="modal-stat-label">Verimlilik:</span>
                    <span class="modal-stat-value" id="previewEfficiency">-</span>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-success" onclick="confirmSubmit()">
                âœ… SÃ¶ylemiyorum Hocam!
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeModal()">
                ğŸ”„ Ben Bi Tekrar GÃ¶zden GeÃ§irmek Ä°stiyorum
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Sayfa yÃ¼klendiÄŸinde
    document.addEventListener('DOMContentLoaded', function() {
        // BugÃ¼nÃ¼n tarihini varsayÄ±lan olarak ayarla
        const dateInput = document.getElementById('date');
        if (dateInput && !dateInput.value) {
            const today = new Date();
            dateInput.valueAsDate = today;
        }

        // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
        const modal = document.getElementById('confirmationModal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }
    });

    function updateEfficiencyValue(value) {
        const display = document.getElementById('efficiencyValue');
        if (display) {
            display.textContent = value;
        }
    }

    // Pop-up gÃ¶ster
    function showConfirmationPopup(event) {
        event.preventDefault();
        event.stopPropagation();
        
        // Form verilerini al
        const subject = document.getElementById('subject').value;
        const hours = document.getElementById('hours').value;
        const efficiency = document.getElementById('efficiency').value;
        
        // Ã–nizleme gÃ¶ster
        const previewSubject = document.getElementById('previewSubject');
        const previewHours = document.getElementById('previewHours');
        const previewEfficiency = document.getElementById('previewEfficiency');
        
        if (previewSubject) previewSubject.textContent = subject || '-';
        if (previewHours) previewHours.textContent = hours ? hours + ' saat' : '-';
        if (previewEfficiency) previewEfficiency.textContent = efficiency ? efficiency + '%' : '-';
        
        // Modal'Ä± gÃ¶ster
        const modal = document.getElementById('confirmationModal');
        if (modal) {
            modal.style.display = 'flex';
        }
        
        return false;
    }

    // Onayla ve gÃ¶nder
    function confirmSubmit() {
        const form = document.getElementById('studyForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('loadingSpinner');
        const successIcon = document.getElementById('successIcon');
        const checkPath = successIcon.querySelector('path');
        
        if (!form || !submitBtn) return;
        
        // Modal'Ä± kapat
        closeModal();
        
        // Butonu disable et
        submitBtn.disabled = true;
        
        // 1. AÅŸama: YÃ¼kleniyor Modu
        btnText.style.opacity = '0';
        setTimeout(() => {
            spinner.style.display = 'block';
        }, 300);
        
        // 2. AÅŸama: Ä°ÅŸlem SimÃ¼lasyonu (1.5 saniye bekle)
        setTimeout(() => {
            spinner.style.display = 'none';
            
            // Butonu yuvarlak hale getir
            submitBtn.classList.add('btn-success');
            
            // Tik iÅŸaretini gÃ¶ster ve animasyonu baÅŸlat
            setTimeout(() => {
                successIcon.classList.add('animate-check');
                triggerConfetti(submitBtn);
                
                // Formu gÃ¶nder
                setTimeout(() => {
                    form.submit();
                }, 500);
            }, 300);
        }, 1500);
    }
    
    // Konfeti Fonksiyonu
    function triggerConfetti(btn) {
        if (typeof confetti === 'undefined') {
            console.warn('Konfeti kÃ¼tÃ¼phanesi yÃ¼klenmedi');
            return;
        }
        
        // Butonun konumunu al
        const rect = btn.getBoundingClientRect();
        const x = (rect.left + rect.width / 2) / window.innerWidth;
        const y = (rect.top + rect.height / 2) / window.innerHeight;
        
        // Efekt 1: Merkezden patlama
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { x: x, y: y },
            colors: ['#5cffa1', '#ffffff', '#FFD700', '#FF69B4', '#2563eb', '#7c3aed']
        });
        
        // Efekt 2: Yanlardan patlama (kÄ±sa gecikmeli)
        setTimeout(() => {
            confetti({
                particleCount: 50,
                angle: 60,
                spread: 55,
                origin: { x: 0 },
                colors: ['#5cffa1', '#ffffff', '#2563eb']
            });
            confetti({
                particleCount: 50,
                angle: 120,
                spread: 55,
                origin: { x: 1 },
                colors: ['#5cffa1', '#ffffff', '#7c3aed']
            });
        }, 200);
    }

    // Modal'Ä± kapat
    function closeModal() {
        const modal = document.getElementById('confirmationModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
</script>
{% endblock %}

