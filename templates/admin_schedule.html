{% extends "base.html" %}

{% block title %}Ã–ÄŸrenci Ders ProgramÄ± - Admin - EducationalTR{% endblock %}

{% block content %}
<div class="admin-schedule-container">
    <div class="admin-schedule-header">
        <h1>ğŸ“… {{ student.full_name }} - Ders ProgramÄ±</h1>
        <p class="subtitle">Ã–ÄŸrenci: {{ student.username }}</p>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <a href="{{ url_for('admin_student_detail', student_id=student.id) }}" class="btn btn-secondary">â† Ã–ÄŸrenci DetayÄ±na DÃ¶n</a>
            {% if active_schedule %}
            <button onclick="editSchedule({{ student.id }}, {{ active_schedule.id }})" class="btn btn-primary">âœï¸ Ders ProgramÄ±nÄ± DÃ¼zenle</button>
            {% else %}
            <button onclick="createSchedule({{ student.id }})" class="btn btn-primary">â• Ders ProgramÄ± OluÅŸtur</button>
            {% endif %}
        </div>
    </div>

    {% if active_schedule %}
    <div class="schedule-info-card">
        <h2>{{ active_schedule.name }}</h2>
        {% if active_schedule.description %}
        <p>{{ active_schedule.description }}</p>
        {% endif %}
        <p class="schedule-meta">
            <span>OluÅŸturulma: {{ active_schedule.created_at }}</span>
            {% if active_schedule.updated_at != active_schedule.created_at %}
            <span> | GÃ¼ncellenme: {{ active_schedule.updated_at }}</span>
            {% endif %}
        </p>
    </div>

    <div class="schedule-week">
        {% set days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'] %}
        {% for day_num in range(7) %}
        <div class="schedule-day">
            <div class="day-header">
                <h3>{{ days[day_num] }}</h3>
            </div>
            <div class="day-items">
                {% for item in schedule_items %}
                {% if item.day_of_week == day_num %}
                <div class="schedule-item admin-item">
                    <div class="item-time">
                        <span class="time-start">{{ item.start_time }}</span>
                        <span class="time-separator">-</span>
                        <span class="time-end">{{ item.end_time }}</span>
                    </div>
                    <div class="item-content">
                        <h4 class="item-subject">{{ item.subject }}</h4>
                        {% if item.location %}
                        <p class="item-location">ğŸ“ {{ item.location }}</p>
                        {% endif %}
                        {% if item.instructor %}
                        <p class="item-instructor">ğŸ‘¤ {{ item.instructor }}</p>
                        {% endif %}
                    </div>
                    <div class="item-completion-status">
                        {% if completions.get(item.id) %}
                        {% set today_completion = completions[item.id]|selectattr('completion_date', 'equalto', today)|list|first %}
                        {% if today_completion and today_completion.is_completed %}
                        <span class="completion-badge completed">âœ“ TamamlandÄ±</span>
                        {% else %}
                        <span class="completion-badge pending">â³ Beklemede</span>
                        {% endif %}
                        <div class="completion-history">
                            <strong>Tamamlama GeÃ§miÅŸi:</strong>
                            <ul>
                                {% for completion in completions[item.id][:5] %}
                                <li>
                                    {{ completion.completion_date }}: 
                                    {% if completion.is_completed %}
                                    <span class="status-completed">âœ“ TamamlandÄ±</span>
                                    {% else %}
                                    <span class="status-pending">â³ Beklemede</span>
                                    {% endif %}
                                    {% if completion.notes %}
                                    - {{ completion.notes }}
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% else %}
                        <span class="completion-badge not-started">â—‹ HenÃ¼z baÅŸlanmadÄ±</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-schedule">
        <div class="empty-icon">ğŸ“…</div>
        <h2>Bu Ã¶ÄŸrencinin henÃ¼z ders programÄ± yok</h2>
        <p>Ã–ÄŸrenci henÃ¼z ders programÄ± oluÅŸturmamÄ±ÅŸ</p>
    </div>
    {% endif %}
</div>

<!-- Ders ProgramÄ± Modal -->
<div id="scheduleModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="scheduleModalTitle">Yeni Ders ProgramÄ± OluÅŸtur</h2>
            <span class="close" onclick="closeScheduleModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="scheduleForm">
                <div class="form-group">
                    <label for="scheduleName">Program AdÄ± *</label>
                    <input type="text" id="scheduleName" name="name" required placeholder="Ã–rn: 2024-2025 GÃ¼z DÃ¶nemi">
                </div>
                
                <div class="form-group">
                    <label for="scheduleDescription">AÃ§Ä±klama</label>
                    <textarea id="scheduleDescription" name="description" rows="3" placeholder="Program hakkÄ±nda notlar..."></textarea>
                </div>
                
                <div class="form-group">
                    <h3>Dersler</h3>
                    <div id="scheduleItems">
                        <!-- Dersler buraya eklenecek -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addScheduleItem()">+ Ders Ekle</button>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeScheduleModal()">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let scheduleItems = [];
    const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
    const studentId = {{ student.id }};

    function createSchedule(studentId) {
        scheduleItems = [];
        document.getElementById('scheduleModalTitle').textContent = 'Yeni Ders ProgramÄ± OluÅŸtur';
        document.getElementById('scheduleName').value = '';
        document.getElementById('scheduleDescription').value = '';
        renderScheduleItems();
        document.getElementById('scheduleModal').style.display = 'block';
    }

    function editSchedule(studentId, scheduleId) {
        document.getElementById('scheduleModalTitle').textContent = 'Ders ProgramÄ±nÄ± DÃ¼zenle';
        
        fetch(`/admin/schedule/${studentId}/data`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (data.schedule) {
                        document.getElementById('scheduleName').value = data.schedule.name;
                        document.getElementById('scheduleDescription').value = data.schedule.description || '';
                        scheduleItems = data.items || [];
                    } else {
                        scheduleItems = [];
                    }
                    renderScheduleItems();
                    document.getElementById('scheduleModal').style.display = 'block';
                } else {
                    alert('Program bilgileri yÃ¼klenirken hata oluÅŸtu');
                }
            })
            .catch(err => {
                console.error('Hata:', err);
                alert('Program bilgileri yÃ¼klenirken hata oluÅŸtu');
            });
    }

    function closeScheduleModal() {
        document.getElementById('scheduleModal').style.display = 'none';
    }

    function addScheduleItem() {
        scheduleItems.push({
            day_of_week: 0,
            start_time: '09:00',
            end_time: '10:00',
            subject: '',
            location: '',
            instructor: ''
        });
        renderScheduleItems();
    }

    function removeScheduleItem(index) {
        scheduleItems.splice(index, 1);
        renderScheduleItems();
    }

    function renderScheduleItems() {
        const container = document.getElementById('scheduleItems');
        container.innerHTML = '';
        
        scheduleItems.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'schedule-item-form';
            itemDiv.innerHTML = `
                <div class="item-form-row">
                    <div class="form-group-inline">
                        <label>GÃ¼n</label>
                        <select onchange="scheduleItems[${index}].day_of_week = parseInt(this.value)">
                            ${days.map((day, i) => `<option value="${i}" ${item.day_of_week === i ? 'selected' : ''}>${day}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group-inline">
                        <label>BaÅŸlangÄ±Ã§</label>
                        <input type="time" value="${item.start_time}" onchange="scheduleItems[${index}].start_time = this.value">
                    </div>
                    <div class="form-group-inline">
                        <label>BitiÅŸ</label>
                        <input type="time" value="${item.end_time}" onchange="scheduleItems[${index}].end_time = this.value">
                    </div>
                </div>
                <div class="item-form-row">
                    <div class="form-group-inline full-width">
                        <label>Ders AdÄ± *</label>
                        <input type="text" value="${item.subject}" required onchange="scheduleItems[${index}].subject = this.value" placeholder="Ã–rn: Matematik">
                    </div>
                </div>
                <div class="item-form-row">
                    <div class="form-group-inline">
                        <label>Yer</label>
                        <input type="text" value="${item.location || ''}" onchange="scheduleItems[${index}].location = this.value" placeholder="Ã–rn: A-101">
                    </div>
                    <div class="form-group-inline">
                        <label>Ã–ÄŸretmen</label>
                        <input type="text" value="${item.instructor || ''}" onchange="scheduleItems[${index}].instructor = this.value" placeholder="Ã–rn: Ahmet YÄ±lmaz">
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeScheduleItem(${index})">Sil</button>
            `;
            container.appendChild(itemDiv);
        });
        
        if (scheduleItems.length === 0) {
            container.innerHTML = '<p class="empty-message">HenÃ¼z ders eklenmemiÅŸ. YukarÄ±daki butona tÄ±klayarak ders ekleyin.</p>';
        }
    }

    document.getElementById('scheduleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            name: document.getElementById('scheduleName').value,
            description: document.getElementById('scheduleDescription').value,
            items: scheduleItems
        };
        
        fetch(`/admin/schedule/${studentId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('Program baÅŸarÄ±yla kaydedildi!');
                location.reload();
            } else {
                alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(err => {
            console.error('Hata:', err);
            alert('Program kaydedilirken hata oluÅŸtu');
        });
    });

    // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
    window.onclick = function(event) {
        const modal = document.getElementById('scheduleModal');
        if (event.target == modal) {
            closeScheduleModal();
        }
    }
</script>
{% endblock %}

