{% extends "base.html" %}

{% block title %}Dashboard - EducationalTR Ã–ÄŸrenci Takip Sistemi{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>HoÅŸ Geldiniz, {{ session.full_name }}! ğŸ‘‹</h1>
        <p class="subtitle">Ã‡alÄ±ÅŸma istatistikleriniz ve geliÅŸiminiz</p>
    </div>

    <!-- Ä°statistik KartlarÄ± -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ğŸ“–</div>
            <div class="stat-content">
                <h3>{{ stats.total_sessions or 0 }}</h3>
                <p>Toplam Ã‡alÄ±ÅŸma</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">â°</div>
            <div class="stat-content">
                <h3>{{ "%.1f"|format(stats.total_hours or 0) }}</h3>
                <p>Toplam Saat</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">â­</div>
            <div class="stat-content">
                <h3>{{ "%.0f"|format(stats.avg_efficiency or 0) }}%</h3>
                <p>Ortalama Verimlilik</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ“…</div>
            <div class="stat-content">
                <h3>{{ stats.study_days or 0 }}</h3>
                <p>Ã‡alÄ±ÅŸma GÃ¼nÃ¼</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-content">
                <h3>{{ "%.1f"|format(avg_percentage) }}%</h3>
                <p>SÄ±nav OrtalamasÄ±</p>
            </div>
        </div>
    </div>

    <!-- Grafikler -->
    <div class="charts-grid">
        <div class="chart-card">
            <h2>GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma Saatleri (Son 30 GÃ¼n)</h2>
            <canvas id="dailyHoursChart"></canvas>
        </div>
        <div class="chart-card">
            <h2>Ders BazÄ±nda Ã‡alÄ±ÅŸma</h2>
            <canvas id="subjectChart"></canvas>
        </div>
        <div class="chart-card">
            <h2>Verimlilik Trendi</h2>
            <canvas id="efficiencyChart"></canvas>
        </div>
    </div>

    <!-- Ortalama HesaplayÄ±cÄ± -->
    <div class="calculator-card">
        <h2>ğŸ¯ Ortalama HesaplayÄ±cÄ±</h2>
        <p>Hedef ortalamaya ulaÅŸmak iÃ§in gerekli notlarÄ± hesaplayÄ±n</p>
        <div class="calculator-form">
            <div class="form-group">
                <label>Hedef Ortalama (0-100)</label>
                <input type="number" id="targetAvg" min="0" max="100" step="0.1" placeholder="Ã–rn: 85">
            </div>
            <div class="form-group">
                <label>Kalan SÄ±nav SayÄ±sÄ±</label>
                <input type="number" id="remainingExams" min="1" value="1">
            </div>
            <button onclick="calculateGrade()" class="btn btn-primary">Hesapla</button>
        </div>
        <div id="gradeResult" class="grade-result"></div>
    </div>

    <!-- Son Ã‡alÄ±ÅŸma KayÄ±tlarÄ± -->
    <div class="recent-section">
        <h2>Son Ã‡alÄ±ÅŸma KayÄ±tlarÄ±</h2>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Ders</th>
                        <th>Saat</th>
                        <th>Verimlilik</th>
                        <th>Notlar</th>
                        <th>Ä°ÅŸlem</th>
                    </tr>
                </thead>
                <tbody>
                    {% if recent_sessions %}
                        {% for session in recent_sessions %}
                        <tr>
                            <td>{{ session.date }}</td>
                            <td>{{ session.subject }}</td>
                            <td>{{ "%.1f"|format(session.hours) }} saat</td>
                            <td>
                                <span class="efficiency-badge efficiency-{{ 'high' if session.efficiency >= 70 else 'medium' if session.efficiency >= 50 else 'low' }}">
                                    {{ session.efficiency }}%
                                </span>
                            </td>
                            <td>{{ session.notes[:50] if session.notes else '-' }}{{ '...' if session.notes and session.notes|length > 50 else '' }}</td>
                            <td>
                                <div class="action-buttons">
                                    <button onclick="editStudySession({{ session.id }})" class="btn-edit" title="DÃ¼zenle">
                                        âœï¸
                                    </button>
                                    <button onclick="deleteStudySession({{ session.id }})" class="btn-delete" title="Sil">
                                        ğŸ—‘ï¸
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="empty-state">HenÃ¼z Ã§alÄ±ÅŸma kaydÄ± eklenmemiÅŸ</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- SÄ±nav SonuÃ§larÄ± -->
    <div class="recent-section">
        <h2>SÄ±nav SonuÃ§larÄ±</h2>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>SÄ±nav AdÄ±</th>
                        <th>Not</th>
                        <th>Maksimum</th>
                        <th>YÃ¼zde</th>
                        <th>Tarih</th>
                        <th>Ä°ÅŸlem</th>
                    </tr>
                </thead>
                <tbody>
                    {% if exams %}
                        {% for exam in exams %}
                        <tr>
                            <td>{{ exam.exam_name }}</td>
                            <td>{{ "%.1f"|format(exam.score) }}</td>
                            <td>{{ "%.1f"|format(exam.max_score) }}</td>
                            <td>
                                <span class="grade-badge grade-{{ 'excellent' if (exam.score * 100 / exam.max_score) >= 90 else 'good' if (exam.score * 100 / exam.max_score) >= 70 else 'average' if (exam.score * 100 / exam.max_score) >= 50 else 'poor' }}">
                                    {{ "%.1f"|format(exam.score * 100 / exam.max_score) }}%
                                </span>
                            </td>
                            <td>{{ exam.exam_date or '-' }}</td>
                            <td>
                                <button onclick="deleteExam({{ exam.id }})" class="btn-delete" title="Sil">
                                    ğŸ—‘ï¸
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="empty-state">HenÃ¼z sÄ±nav sonucu eklenmemiÅŸ</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ã‡alÄ±ÅŸma KaydÄ± DÃ¼zenleme Modal -->
<div id="editStudyModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>âœï¸ Ã‡alÄ±ÅŸma KaydÄ±nÄ± DÃ¼zenle</h2>
            <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editStudyForm" onsubmit="event.preventDefault(); updateStudySession();">
                <input type="hidden" id="editSessionId">
                
                <div class="form-group">
                    <label for="editDate">Tarih *</label>
                    <input type="date" id="editDate" required>
                </div>

                <div class="form-group">
                    <label for="editSubject">Ders/Konu *</label>
                    <input type="text" id="editSubject" required placeholder="Ã–rn: Matematik, Fizik, Kimya...">
                </div>

                <div class="form-group">
                    <label for="editHours">Ã‡alÄ±ÅŸma SÃ¼resi (Saat) *</label>
                    <input type="number" id="editHours" min="0.1" max="24" step="0.1" required placeholder="Ã–rn: 2.5">
                </div>

                <div class="form-group">
                    <label for="editEfficiency">Verimlilik (%) *</label>
                    <input type="range" id="editEfficiency" min="0" max="100" value="50" oninput="updateEditEfficiencyValue(this.value)" required>
                    <div class="range-display">
                        <span id="editEfficiencyValue">50</span>%
                    </div>
                </div>

                <div class="form-group">
                    <label for="editNotes">Notlar (Opsiyonel)</label>
                    <textarea id="editNotes" rows="4" placeholder="Ã‡alÄ±ÅŸtÄ±ÄŸÄ±nÄ±z konular, Ã¶nemli noktalar..."></textarea>
                </div>

                <div class="form-group">
                    <label for="editDifficulties">AnlamadÄ±ÄŸÄ±nÄ±z Yerler (Opsiyonel)</label>
                    <textarea id="editDifficulties" rows="3" placeholder="AnlamadÄ±ÄŸÄ±nÄ±z veya zorlandÄ±ÄŸÄ±nÄ±z konular..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">GÃ¼ncelle</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Grafikleri yÃ¼kle
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            // GÃ¼nlÃ¼k saatler grafiÄŸi
            const dailyCtx = document.getElementById('dailyHoursChart').getContext('2d');
            new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: data.daily_hours.map(d => d.date),
                    datasets: [{
                        label: 'Ã‡alÄ±ÅŸma Saatleri',
                        data: data.daily_hours.map(d => d.hours),
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Ders bazÄ±nda grafik
            const subjectCtx = document.getElementById('subjectChart').getContext('2d');
            new Chart(subjectCtx, {
                type: 'doughnut',
                data: {
                    labels: data.subject_hours.map(s => s.subject),
                    datasets: [{
                        data: data.subject_hours.map(s => s.hours),
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Verimlilik trendi (gÃ¼nlÃ¼k)
            if (data.efficiency_trend && data.efficiency_trend.length > 0) {
                const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
                new Chart(efficiencyCtx, {
                    type: 'line',
                    data: {
                        labels: data.efficiency_trend.map(e => {
                            // SQLite date formatÄ±: YYYY-MM-DD
                            if (e.date) {
                                const dateParts = e.date.split('-');
                                if (dateParts.length === 3) {
                                    const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                                    return date.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' });
                                }
                            }
                            return e.date || '';
                        }),
                        datasets: [{
                            label: 'Verimlilik (%)',
                            data: data.efficiency_trend.map(e => parseFloat(e.efficiency) || 0),
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: 'rgba(34, 197, 94, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // Veri yoksa mesaj gÃ¶ster
                const efficiencyCtx = document.getElementById('efficiencyChart');
                if (efficiencyCtx) {
                    efficiencyCtx.parentElement.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--gray);">HenÃ¼z verimlilik verisi yok. Ã‡alÄ±ÅŸma kaydÄ± ekledikÃ§e grafik oluÅŸacak.</p>';
                }
            }
        })
        .catch(error => {
            console.error('Grafik yÃ¼kleme hatasÄ±:', error);
            const efficiencyCtx = document.getElementById('efficiencyChart');
            if (efficiencyCtx) {
                efficiencyCtx.parentElement.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--gray);">Grafik yÃ¼klenirken bir hata oluÅŸtu. LÃ¼tfen sayfayÄ± yenileyin.</p>';
            }
        });

    function calculateGrade() {
        const targetAvg = parseFloat(document.getElementById('targetAvg').value);
        const remainingExams = parseInt(document.getElementById('remainingExams').value);
        const resultDiv = document.getElementById('gradeResult');

        if (!targetAvg || targetAvg <= 0 || targetAvg > 100) {
            resultDiv.innerHTML = '<div class="alert alert-error">LÃ¼tfen geÃ§erli bir hedef ortalama girin (0-100)</div>';
            return;
        }

        fetch('/calculate-grade', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                target_avg: targetAvg,
                remaining_exams: remainingExams
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h3>ğŸ“Š Hesaplama Sonucu</h3>
                        <p><strong>Mevcut Ortalama:</strong> ${data.current_avg}%</p>
                        <p><strong>Hedef Ortalama:</strong> ${data.target_avg}%</p>
                        <p><strong>Kalan SÄ±nav SayÄ±sÄ±:</strong> ${data.remaining_exams}</p>
                        <p class="result-highlight">ğŸ¯ <strong>Gerekli Ortalama:</strong> ${data.needed_avg_per_exam}%</p>
                        <p>${data.message}</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('Hesaplama hatasÄ±:', error);
            resultDiv.innerHTML = `<div class="alert alert-error">Bir hata oluÅŸtu: ${error.message}</div>`;
        });
    }

    // Ã‡alÄ±ÅŸma kaydÄ± dÃ¼zenle
    function editStudySession(id) {
        // KayÄ±t bilgilerini getir
        fetch('/get-study/' + id)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const study = data.data;
                    // Modal'Ä± doldur
                    document.getElementById('editSessionId').value = study.id;
                    document.getElementById('editDate').value = study.date;
                    document.getElementById('editSubject').value = study.subject;
                    document.getElementById('editHours').value = study.hours;
                    document.getElementById('editEfficiency').value = study.efficiency;
                    document.getElementById('editEfficiencyValue').textContent = study.efficiency;
                    document.getElementById('editNotes').value = study.notes || '';
                    document.getElementById('editDifficulties').value = study.difficulties || '';
                    
                    // Modal'Ä± gÃ¶ster
                    document.getElementById('editStudyModal').style.display = 'flex';
                } else {
                    alert('KayÄ±t bilgileri alÄ±namadÄ±: ' + (data.error || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                alert('Bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
            });
    }

    // GÃ¼ncelleme formunu gÃ¶nder
    function updateStudySession() {
        const id = document.getElementById('editSessionId').value;
        const formData = {
            date: document.getElementById('editDate').value,
            subject: document.getElementById('editSubject').value,
            hours: parseFloat(document.getElementById('editHours').value),
            efficiency: parseInt(document.getElementById('editEfficiency').value),
            notes: document.getElementById('editNotes').value,
            difficulties: document.getElementById('editDifficulties').value
        };

        fetch('/update-study/' + id, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Ã‡alÄ±ÅŸma kaydÄ± baÅŸarÄ±yla gÃ¼ncellendi!');
                document.getElementById('editStudyModal').style.display = 'none';
                location.reload();
            } else {
                alert('GÃ¼ncelleme baÅŸarÄ±sÄ±z: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(error => {
            console.error('GÃ¼ncelleme hatasÄ±:', error);
            alert('Bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
        });
    }

    // Modal'Ä± kapat
    function closeEditModal() {
        document.getElementById('editStudyModal').style.display = 'none';
    }

    // Verimlilik deÄŸerini gÃ¼ncelle
    function updateEditEfficiencyValue(value) {
        document.getElementById('editEfficiencyValue').textContent = value;
    }

    // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
    window.onclick = function(event) {
        const modal = document.getElementById('editStudyModal');
        if (event.target == modal) {
            closeEditModal();
        }
    }

    // Ã‡alÄ±ÅŸma kaydÄ± sil
    function deleteStudySession(id) {
        if (confirm('Bu Ã§alÄ±ÅŸma kaydÄ±nÄ± silmek istediÄŸinize emin misiniz?')) {
            fetch('/delete-study/' + id, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Silme iÅŸlemi baÅŸarÄ±sÄ±z: ' + (data.error || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('Silme hatasÄ±:', error);
                alert('Bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
            });
        }
    }

    // SÄ±nav sonucu sil
    function deleteExam(id) {
        if (confirm('Bu sÄ±nav sonucunu silmek istediÄŸinize emin misiniz?')) {
            fetch('/delete-exam/' + id, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Silme iÅŸlemi baÅŸarÄ±sÄ±z: ' + (data.error || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('Silme hatasÄ±:', error);
                alert('Bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
            });
        }
    }
</script>
{% endblock %}

